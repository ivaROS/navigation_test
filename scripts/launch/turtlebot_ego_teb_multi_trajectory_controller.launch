<launch>
  <arg name="debug" default="false"/>

  <arg name="debug_prefix" value="" unless="$(arg debug)"/> <!-- valgrind - -tool=callgrind -->
  <arg name="debug_prefix" value="xterm -e gdb -ex run -args" if="$(arg debug)"/>
  <!--<arg name="debug_prefix" value="valgrind" if="$(arg debug)"/>-->

  <arg name="initial_trajectory_factor" default="$(optenv GM_PARAM_INITIAL_TRAJECTORY_FACTOR 0.6)"/>
  <arg name="use_projection_operator" default="$(optenv GM_PARAM_USE_PROJECTION_OPERATOR false)"/>
  <arg name="mpc_update_period" default="$(optenv GM_PARAM_MPC_UPDATE_PERIOD 0.5)"/>
  <arg name="max_replan_period" default="$(optenv GM_PARAM_MAX_REPLAN_PERIOD -1)"/>
  <arg name="replan_min_tte" default="$(optenv GM_PARAM_REPLAN_MIN_TTE 0)"/>
  <arg name="replan_min_ttc" default="$(optenv GM_PARAM_REPLAN_MIN_TTC 3)"/>
  <arg name="replan_exclusion_radius" default="$(optenv GM_PARAM_REPLAN_EXCLUSION_RADIUS 0.3)"/>
  <arg name="gap_goal_min_dist" default="$(optenv GM_PARAM_GAP_GOAL_MIN_DIST 0.2)"/>
  <arg name="egocircle" default="true"/>
  <arg name="transformed_egocircle" default="$(optenv GM_PARAM_TRANSFORMED_EGOCIRCLE true)"/>

  <arg name="narrow_gap_threshold_factor" default="$(optenv GM_PARAM_NARROW_GAP_THRESHOLD_FACTOR 1.5)"/>
  <arg name="goal_sampling_des_extension_dist" default="$(optenv GM_PARAM_GAP_SAMPLING_DES_EXTENSION_DIST 0.2)"/>
  <arg name="goal_sampling_safety_dist" default="$(optenv GM_PARAM_GAP_SAMPLING_SAFETY_DIST 0.2)"/>
  <arg name="narrow_gap_prevent_replan_dist_factor" default="$(optenv GM_PARAM_NARROW_GAP_PREVENT_REPLAN_DIST_FACTOR 2)"/>


  <arg name="raw_egocircle_topic" default="/point_scan"/>

  <node name="egocircle_node" pkg="egocircle" type="ego_circle" if="$(arg egocircle)"/>
  <node name="egocircle_remapper" pkg="egocircle_utils" type="remapper_node" if="$(eval egocircle and transformed_egocircle)"/>

  <arg name="planning_frame_id" default="odom"/>
  <arg name="fixed_frame_id" default="map"/> <!--NOTE: This should really be 'map', but something broke when doing that -->
  <arg name="map_frame_id" default="map"/>

  <param name="base_frame_id" value="base_footprint"/>

  <arg name="param" default="simplified_robot_description"/>

  <arg name="urdf_file" default="$(find xacro)/xacro '$(find turtlebot_trajectory_testing)/urdf/cylinder_model.urdf' --inorder" />
  <param name="$(arg param)" command="$(arg urdf_file)" />

  <env name="ROSCONSOLE_CONFIG_FILE" value="$(find teb_trajectory_nav)/data/teb_multigoal_limit_logging.conf"/>

  <node pkg="teb_trajectory_nav" type="teb_behavior_test_node" respawn="false" name="teb_global_planner" output="screen" clear_params="true" launch-prefix="$(arg debug_prefix)">
    <rosparam file="$(find teb_trajectory_nav)/param/teb_params.yaml" command="load" ns="teb_trajectory_source"/>
    <rosparam file="$(find teb_trajectory_nav)/param/ego_teb_params.yaml" command="load" ns="teb_trajectory_source"/>
    <rosparam file="$(find teb_trajectory_nav)/param/multi_goal_params.yaml" command="load" ns="teb_trajectory_source"/>

    <rosparam file="$(find nav_configs)/config/common_costmap_params.yaml" command="load" ns="global_costmap"/>
    <rosparam file="$(find nav_configs)/config/global_costmap_params_no_ns.yaml" command="load" ns="global_costmap"/>

    <param name="egocircle_collision_checker/robot_model/param_name" value="$(arg param)"/>

    <param name="planning_frame_id" value="$(arg planning_frame_id)"/>
    <param name="fixed_frame_id" value="odom"/>
    <param name="odom_frame_id" value="odom"/>
    <param name="base_frame_id" value="base_footprint"/>
    <param name="global_goal_state/fixed_frame_id" value="map"/>

    <param name="teb_trajectory_scoring/initial_trajectory_factor" value="$(arg initial_trajectory_factor)"/>
    <param name="teb_trajectory_source/detour_threshold" value="-1"/>
    <param name="teb_trajectory_source/gap_goal_min_dist" value="$(arg gap_goal_min_dist)"/>
    <!--<param name="basic_replan_logic/max_replan_period" value="0.2"/>
    <param name="basic_replan_logic/min_tte" value="1"/>-->
    <param name="teb_replan_logic/max_replan_period" value="$(arg max_replan_period)"/>
    <param name="teb_replan_logic/min_tte" value="$(arg replan_min_tte)"/>
    <param name="online_verifier/min_ttc" value="$(arg replan_min_ttc)"/>
    <param name="teb_replan_logic/replan_exclusion_radius" value="$(arg replan_exclusion_radius)"/>

    <param name="use_projection_operator" value="$(arg use_projection_operator)"/>

    <param name="teb_trajectory_source/ego_circle_cost_impl/potential_gap_interface/planning_inflated" value="true"/>
    <param name="teb_trajectory_source/ego_circle_cost_impl/potential_gap_interface/scale" value="1.5"/>
    <param name="teb_trajectory_source/egocircle_interface_wrapper/ego_circle_topic" value="$(eval '/transformed_scan' if transformed_egocircle else arg('raw_egocircle_topic'))"/>
    <param name="egocircle_cc_wrapper/ego_circle_topic" value="$(arg raw_egocircle_topic)"/>
    <param name="teb_mpc/update_period" value="$(arg mpc_update_period)"/>
    <rosparam file="$(find teb_trajectory_nav)/param/teb_params.yaml" command="load" ns="teb_mpc/teb_reoptimizer"/>
    <rosparam file="$(find teb_trajectory_nav)/param/ego_teb_params.yaml" command="load" ns="teb_mpc/teb_reoptimizer"/>
    <param name="teb_mpc/teb_reoptimizer/detour_threshold" value="-1"/>
    <param name="teb_mpc/teb_reoptimizer/egocircle_interface_wrapper/ego_circle_topic" value="$(arg raw_egocircle_topic)"/>
    <!--<param name="teb_trajectory_source/legacy_egocircle/egocircle_interface_wrapper/ego_circle_topic" value="$(arg raw_egocircle_topic)"/>-->
    <!--<param name="teb_mpc/teb_reoptimizer/no_inner_iterations" value="6"/>-->
    <!--<param name="teb_mpc/dt_ref" value="0.1"/>-->

    <param name="teb_trajectory_source/narrow_gap_threshold_factor" value="$(arg narrow_gap_threshold_factor)"/>
    <param name="teb_trajectory_source/goal_sampling_des_extension_dist" value="$(arg goal_sampling_des_extension_dist)"/>
    <param name="teb_trajectory_source/goal_sampling_safety_dist" value="$(arg goal_sampling_safety_dist)"/>
    <param name="teb_trajectory_source/narrow_gap_prevent_replan_dist_factor" value="$(arg narrow_gap_prevent_replan_dist_factor)"/>

  </node>


</launch>

